<p-breadcrumb [model]="breadcrumbItems"></p-breadcrumb>
<div class="card">
    <div class="font-semibold text-xl mb-4">
        <p-button 
            [icon]="'pi pi-filter'"   
            [severity]="'success'" 
            (onClick)="showFilterDrawer()" class="mr-2"/>
        <p-button *ngIf="isFilterApplied"
            [icon]="'pi pi-filter-slash'"   
            [severity]="'danger'" 
            (onClick)="onClearFilter()" class="mr-2"/>

        <p-button
            [loading]="loadingExport"
            [icon]="'pi pi-file-excel'"   
            [severity]="'success'" 
            (onClick)="exportToCSV()" class="mr-2"/>
    </div>
    <p-table *ngIf="response" showGridlines stripedRows size="small" [value]="response?.data" [loading]="loading" [paginator]="false" [rows]="50">
        <ng-template pTemplate="header">
            <tr>
            <th style="width:45px">SN</th>
            <th>Name</th>
            <th>Amount</th>
            <th>Vendor Name</th>
            <th>Bill</th>
            <th>Expense Head</th>
            <th>Expense Date</th>
            <th *ngIf="isVisibleVerified">Site</th>
            <th *ngIf="false">Approved By</th>
            <th *ngIf="false">Approved Date</th>
            <th *ngIf="false">Remarks</th>
            <th>Action</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
            <tr>
            <td>{{ rowIndex+1 }}</td>
            <td>
                {{ row.expense_expense_by?.first_name }} {{ row.expense_expense_by?.last_name }}
            </td>
            <td [title]="row.description">{{ row.expense_amount }}</td>
            <td>{{ row.vendor_name }}</td>
            <td>
                <p-image 
                    *ngIf="row?.bill_image" 
                    [src]="row.bill_image" 
                    alt="Bill Image"
                    preview
                    class="rounded shadow"
                    height="30"
                    width="30"
                ></p-image>
            </td>
            <td>{{ row.expense_expense_head?.name }}</td>
            <td>
                {{ row.date | date:'dd-MM-yyyy' }}
            </td>
            <td *ngIf="isVisibleVerified">{{ row.expense_office_location?.name }}</td>
            <td *ngIf="false">
                {{ row.expense_approved_by?.name }}
            </td>
            <td *ngIf="false">{{ row.date_approved | date:'dd-MM-yyyy' }}</td>
            <td *ngIf="false">{{ row.remarks }}</td>
            <td>
                <p-button (click)="showRemarksModal(row.expense_id, 'approve')" title="Approve" icon="pi pi-check" severity="info" class="mr-2" />
                <p-button (click)="showRemarksModal(row.expense_id, 'reject')" title="Reject" icon="pi pi-times" severity="danger" />
            </td>
            </tr>
        </ng-template>
    </p-table>
    <div class="mt-2 flex justify-end items-center" *ngIf="response?.data?.length > 0 && paginationText">
      <div class="mr-2"> 
        {{ paginationText }}
      </div>
      <p-buttongroup>
        <p-button type="button" label="Prev" icon="pi pi-chevron-left" (onClick)="prev()" [disabled]="isFirstPage()" outlined />
        <!-- <p-button type="button" icon="pi pi-refresh" (click)="reset()" text /> -->
        <p-button type="button" label="Next" icon="pi pi-chevron-right" (onClick)="next()" [disabled]="isLastPage()" outlined iconPos="right" />
      </p-buttongroup>
    </div>
</div>

<p-dialog header="Remarks" (onHide)="onCloseRemarksModel()" [(visible)]="visibleRemarksModal" [modal]="true" [closable]="true" [style]="{width: '400px'}">
    <form [formGroup]="remarksForm" (ngSubmit)="onSubmit()">
        <div class="grid grid-cols-2 gap-6">
    
            <!-- Remarks -->
            <div class="field">
                <label class="block" for="remarks">Remarks</label>
                <input id="remarks" pInputText formControlName="remarks" />
                <div *ngIf="remarksForm.get('remarks')?.touched && remarksForm.get('remarks')?.invalid" class="error">
                    <small *ngIf="remarksForm.get('remarks')?.errors?.['required']" class="text-red-500">
                        Remarks are required.
                    </small>
                    <small *ngIf="remarksForm.get('remarks')?.errors?.['maxlength']" class="text-red-500">
                        Maximum 255 characters allowed.
                    </small>
                </div>
            </div>
            <div class="field mt-3 text-right">
                <p-button type="submit" label="Submit" [loading]="loadingRemarks" [disabled]="remarksForm.invalid" />
            </div>
        </div>
    </form>
</p-dialog>

<p-drawer header="Advance Filter" [(visible)]="visibleUserFilter" position="right">
    <div class="grid grid-cols-1 gap-6">
        <form [formGroup]="userFilterForm" (ngSubmit)="onSubmitFilter()" class="flex flex-col gap-2">

            <!-- Name -->
            <div class="flex flex-col">
                <label for="name" class="mb-1">Name</label>
                <input
                id="name"
                type="text"
                pInputText
                maxlength="255"
                formControlName="name"
                />
                <!-- <small class="text-red-500" *ngIf="userFilterForm.get('name')?.touched && userFilterForm.get('name')?.invalid">
                Name is required (max 255 chars).
                </small> -->
            </div>

            <!-- Venor Name -->
            <div class="flex flex-col">
                <label for="vendor_name" class="mb-1">Vendor Name</label>
                <input
                id="vendor_name"
                type="text"
                pInputText
                maxlength="255"
                formControlName="vendor_name"
                />
                <!-- <small class="text-red-500" *ngIf="userFilterForm.get('vendor_name')?.touched && userFilterForm.get('vendor_name')?.invalid">
                Vendor Name is required (max 255 chars).
                </small> -->
            </div>

            <!-- Expense Head -->
            <div class="flex flex-col">
                <label for="expense_expense_head" class="mb-1">Expense Head</label>
                <input
                id="expense_expense_head"
                type="text"
                pInputText
                maxlength="255"
                formControlName="expense_expense_head"
                />
                <!-- <small class="text-red-500" *ngIf="userFilterForm.get('expense_expense_head')?.touched && userFilterForm.get('expense_expense_head')?.invalid">
                Expense Head is Required (max 255 chars).
                </small> -->
            </div>

            <!-- Date -->
            <div class="flex flex-col">
                <label for="date" class="mb-1">Date</label>
                <p-datepicker
                    id="date"
                    dateFormat="dd-mm-yy"
                    formControlName="date"
                    styleClass="w-full"
                />
                <!-- <small class="text-red-500" *ngIf="userFilterForm.get('date')?.touched && userFilterForm.get('date')?.invalid">
                Date is Required (max 255 chars).
                </small> -->
            </div>

            <!-- Amount Id -->
            <div class="flex flex-col">
                <label for="amount" class="mb-1">Amount</label>
                <input
                id="amount"
                type="text"
                pInputText
                maxlength="255"
                formControlName="amount"
                (input)="checkAmountInput('amount')"
                />
                <!-- <small class="text-red-500" *ngIf="userFilterForm.get('amount')?.touched && userFilterForm.get('amount')?.invalid">
                Amount Id is Required (max 255 chars).
                </small> -->
            </div>

            <!-- Site Dropdown -->
            <div class="flex flex-col" *ngIf="sites.length > 0">
                <label for="expense_office_location" class="mb-1">Site</label>
                <p-select
                id="expense_office_location"
                formControlName="expense_office_location"
                [options]="sites"
                optionLabel="name"
                optionValue="id"
                placeholder="Select Status"
                class="w-full"
                ></p-select>
                <!-- <small class="text-red-500" *ngIf="userFilterForm.get('expense_office_location')?.touched && userFilterForm.get('expense_office_location')?.invalid">
                Site is required.
                </small> -->
            </div>

            <div class="flex justify-between mt-4">
                <p-button label="Clear" [outlined]="true" (onClick)="clearAdvanceFilter()" />
                <button [loading]="loadingAdvanceFilter" [disabled]="loadingAdvanceFilter || !enableAdvSearch" pButton type="submit" label="Submit" ></button>
            </div>
        </form>

    </div>
</p-drawer>